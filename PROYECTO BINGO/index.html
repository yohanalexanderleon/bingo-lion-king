<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRAN BINGO LION KING</title>
    <style>
        body { 
            font-family: 'Verdana', sans-serif; 
            text-align: center; 
            margin: 0; 
            padding: 10px; 
            padding-bottom: 100px; /* Espacio extra para la barra de pago */
            user-select: none; 
            color: white;
            background-color: #2c3e50; /* Color base por si falla la imagen */
            
            /* IMAGEN DE FONDO */
            background-image: url('fondo.png'); 
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        .contenedor-principal {
            background-color: rgba(0, 0, 0, 0.85);
            padding: 15px;
            border-radius: 15px;
            display: inline-block;
            width: 100%;
            max-width: 900px;
            box-sizing: border-box;
            box-shadow: 0 0 30px rgba(0,0,0,0.9);
        }

        /* --- GRID DE BOTONES MEJORADO --- */
        .grid-botones { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(65px, 1fr)); 
            gap: 8px; 
            margin: 20px 0; 
        }
        
        .btn-carton { 
            width: 100%; 
            padding: 15px 0; 
            border-radius: 8px; 
            border: none; 
            font-weight: bold; 
            font-size: 1.1rem; 
            position: relative; 
            cursor: pointer;
            transition: all 0.1s;
            background: #27ae60; /* Verde libre por defecto */
            color: white;
            border-bottom: 4px solid #1e8449;
        }
        
        .btn-carton:active { transform: scale(0.95); border-bottom: 2px solid #1e8449; }
        
        /* ESTADOS DEL CART√ìN */
        .seleccionada { 
            background-color: #8e44ad !important; 
            border-color: #6c3483 !important;
            transform: scale(1.05);
            box-shadow: 0 0 10px #8e44ad;
            z-index: 5;
        }
        .seleccionada::after { content: "‚úî"; position: absolute; top: 2px; right: 2px; font-size: 0.7rem; }

        .mio { 
            background-color: #3498db !important; 
            border-color: #2980b9 !important;
            animation: latido-suave 2s infinite; 
        }
        
        .ocupado { 
            background-color: #e74c3c !important; 
            border-color: #c0392b !important;
            opacity: 0.6; 
            cursor: not-allowed; 
        }

        /* BARRA INFERIOR DE PAGO (SIEMPRE VISIBLE AL SELECCIONAR) */
        .barra-pago {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #2c3e50;
            border-top: 4px solid #f1c40f;
            padding: 15px 20px;
            box-sizing: border-box;
            display: none; /* Se activa con JS */
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }

        .info-total { text-align: left; }
        .info-total div { font-size: 0.9rem; color: #ccc; }
        .info-total b { font-size: 1.4rem; color: #f1c40f; }

        .btn-pagar-final {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 30px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(39, 174, 96, 0.4);
        }

        /* PANTALLA JUEGO */
        #pantalla-juego { display: none; }
        .area-cartones { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }
        
        .tarjeta-carton {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.3);
            width: 100%;
            max-width: 320px;
        }

        .grid-juego { display: grid; grid-template-columns: repeat(5, 1fr); gap: 3px; }
        .celda { background: #ecf0f1; color: #333; height: 45px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.1rem; border-radius: 4px; }
        .header { background: #c0392b; color: white; padding: 5px; font-weight: bold; border-radius: 4px; margin-bottom: 5px; }
        .marcada { background: #27ae60 !important; color: white !important; transform: scale(0.95); border: 2px solid #1e8449;}
        
        /* MODAL */
        #modal-pago { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; align-items: center; justify-content: center; }
        .caja { background: white; color: #333; padding: 25px; border-radius: 15px; width: 90%; max-width: 350px; text-align: left; }
        input { width: 100%; padding: 12px; margin: 8px 0 15px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        .btn-enviar { background: #27ae60; color: white; width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer; font-weight: bold; }

        .aviso-ganador { background: #f1c40f; color: black; padding: 15px; font-weight: bold; display: none; margin-bottom: 20px; border-radius: 10px; animation: latido 1s infinite; border: 4px solid white; }
        @keyframes latido { 0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);} }
        @keyframes latido-suave { 0% {box-shadow: 0 0 5px #3498db;} 50% {box-shadow: 0 0 20px #3498db;} 100% {box-shadow: 0 0 5px #3498db;} }
    </style>
</head>
<body>

    <div class="contenedor-principal">
        
        <div id="pantalla-seleccion">
            <h1 style="color:#f1c40f; text-shadow: 2px 2px 4px black; margin:0; font-size: 2rem;">BINGO LION KING</h1>
            <p style="color:#ddd;">Toca los n√∫meros para seleccionarlos.</p>

            <button id="btn-entrar-juego" onclick="entrarModoJuego()" style="display:none; width:100%; padding:15px; background:#3498db; color:white; border:none; border-radius:8px; font-weight:bold; font-size:1.1rem; margin-bottom:20px; animation:latido-suave 2s infinite; cursor:pointer; border: 2px solid white;">
                ‚ñ∂Ô∏è IR A MIS TABLAS (<span id="count-mis-tablas">0</span>)
            </button>

            <div class="grid-botones" id="contenedor-botones">
                <div style="grid-column: 1/-1; padding: 20px;">Cargando cartones...</div>
            </div>
        </div>

        <div id="pantalla-juego">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <button onclick="volverAlLobby()" style="background:#e74c3c; color:white; border:none; padding:8px 15px; border-radius:20px; font-weight:bold; cursor:pointer;">‚¨ÖÔ∏è Volver</button>
                <div style="color:#bbb;">Mesa de Juego</div>
            </div>

            <div class="aviso-ganador" id="aviso-gane">üèÜ ¬°HAY BINGO! ¬°TENEMOS UN GANADOR! üèÜ</div>
            <div id="area-cartones" class="area-cartones"></div>
        </div>

    </div>

    <div id="barra-pago" class="barra-pago">
        <div class="info-total">
            <div id="resumen-cant">0 tablas</div>
            <b id="resumen-total">0,00 Bs</b>
        </div>
        <button class="btn-pagar-final" onclick="abrirModal()">‚úÖ PAGAR</button>
    </div>

    <div id="modal-pago">
        <div class="caja">
            <h3 style="margin-top:0; color:#2c3e50;">Confirmar Compra</h3>
            
            <div style="background:#f9f9f9; padding:12px; border-radius:8px; margin-bottom:15px; font-size:0.9rem; border-left: 5px solid #27ae60; color:#333;">
                Est√°s comprando: <b id="modal-cant">0</b> tablas<br>
                Total a Pagar: <b id="modal-total" style="font-size:1.1rem; color:#c0392b;">0</b> Bs<br><br>
                <strong>DATOS PAGO M√ìVIL:</strong><br>
                Banco: <b>VENEZUELA (0102)</b><br>
                C.I: <b>12.345.678</b><br> Telf: <b>0414-1234567</b>
            </div>
            
            <label>Tu Nombre:</label>
            <input type="text" id="inp-nombre" placeholder="Ej: Juan P√©rez">
            <label>WhatsApp:</label>
            <input type="tel" id="inp-telf" placeholder="Ej: 04121234567">
            <label>Ref. Bancaria (4 d√≠gitos):</label>
            <input type="number" id="inp-ref" placeholder="Ej: 8821">
            
            <button class="btn-enviar" onclick="enviarPago()">ENVIAR COMPROBANTE</button>
            <button onclick="document.getElementById('modal-pago').style.display='none'" style="background:none; border:none; color:#e74c3c; margin-top:15px; width:100%; cursor:pointer; font-weight:bold;">Cancelar</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // DATOS DE FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDTa4-EIIrQLal_njRlaDg4SqITEvTpKNw",
            authDomain: "bingolionking.firebaseapp.com",
            databaseURL: "https://bingolionking-default-rtdb.firebaseio.com",
            projectId: "bingolionking",
            storageBucket: "bingolionking.firebasestorage.app",
            messagingSenderId: "247235213665",
            appId: "1:247235213665:web:b97965cdced2b2ae16ed20"
        };

        const LISTA_CARTONES = [
            [3,7,14,2,4,26,18,29,20,24,36,39,"FREE",43,35,58,46,57,54,51,64,65,61,68,62],[9,7,10,13,6,25,22,29,19,24,36,42,"FREE",31,33,52,55,60,48,54,66,64,62,67,63],[3,14,4,11,13,21,30,17,26,27,32,39,"FREE",35,41,52,57,47,55,54,73,72,69,66,70],[5,8,15,4,3,21,27,30,16,28,44,45,"FREE",42,33,49,47,52,46,48,71,72,75,61,68],[11,10,13,8,6,16,25,19,27,18,36,41,"FREE",39,34,56,51,58,48,53,73,65,69,72,63],[1,12,15,6,14,26,24,30,16,23,40,36,"FREE",39,44,53,55,47,48,54,71,68,63,61,64],[5,14,6,2,4,21,22,29,23,18,34,36,"FREE",37,32,53,56,49,55,52,62,63,74,64,68],[13,2,15,4,3,19,24,28,26,18,32,34,"FREE",38,33,51,47,50,52,49,68,64,73,70,69],[10,5,12,3,8,18,27,30,26,23,31,37,"FREE",40,35,57,47,60,53,49,67,74,73,68,70],[2,7,6,13,4,25,20,24,19,21,32,43,"FREE",33,39,48,54,47,52,59,66,72,70,73,71],[4,2,9,14,8,24,23,30,18,22,38,31,"FREE",41,45,50,48,54,52,46,72,74,66,61,70],[2,15,12,11,7,28,27,26,29,23,43,41,"FREE",37,36,59,55,52,57,54,61,63,68,71,74],[2,14,8,13,5,22,26,21,25,19,38,42,"FREE",35,40,54,50,58,46,49,61,63,70,65,73],[14,15,11,9,6,23,22,27,17,21,44,42,"FREE",45,40,51,58,48,47,60,68,63,61,62,65],[5,9,2,3,7,24,30,23,22,25,32,42,"FREE",43,31,48,47,56,52,50,67,64,62,61,63],[15,8,12,14,5,24,26,22,23,19,32,35,"FREE",43,36,47,53,50,60,56,61,69,66,68,72],[6,8,9,10,14,28,18,30,20,21,33,31,"FREE",39,40,57,53,54,58,60,69,75,71,63,61],[11,10,6,7,5,29,20,30,28,18,33,32,"FREE",31,44,50,59,58,46,60,71,66,64,69,67],[12,5,6,15,4,22,30,20,29,26,41,37,"FREE",32,39,53,55,60,58,56,67,65,62,66,69],[7,3,9,6,12,17,16,29,26,21,31,41,"FREE",39,38,47,49,53,46,55,63,71,61,66,62],[11,6,8,13,5,29,30,27,22,25,39,36,"FREE",32,33,60,58,57,53,46,75,65,71,72,62],[7,8,3,14,6,17,16,20,27,30,44,41,"FREE",35,34,52,60,47,58,46,64,71,74,63,75],[3,9,11,1,15,18,29,20,21,22,43,36,"FREE",32,42,51,58,52,60,49,74,67,65,63,72],[9,2,5,14,6,18,17,20,25,19,31,38,"FREE",45,40,60,47,51,52,53,70,65,72,67,63],[7,2,12,6,11,27,20,25,16,26,40,41,"FREE",45,33,46,56,51,60,50,62,63,71,70,73],[7,13,5,2,12,26,17,22,18,27,38,33,"FREE",42,35,51,55,48,47,46,75,70,65,69,72],[14,1,12,10,7,18,29,20,16,27,35,34,"FREE",40,45,46,53,60,58,55,63,62,65,70,68],[4,12,2,14,3,16,30,19,29,23,37,44,"FREE",40,43,47,52,59,57,50,62,70,63,69,71],[13,3,8,11,7,23,27,30,29,16,42,37,"FREE",32,38,46,50,48,56,53,71,73,66,63,74],[8,7,5,10,15,23,28,21,16,26,44,42,"FREE",33,40,47,60,53,46,51,68,63,75,71,62],[5,13,4,10,6,28,17,26,24,30,36,44,"FREE",31,34,50,51,58,46,53,61,72,68,65,63],[10,4,5,11,3,28,16,30,21,22,42,31,"FREE",45,41,46,48,50,60,56,69,64,68,75,72],[4,10,13,6,14,29,16,21,18,26,41,36,"FREE",38,39,53,47,57,59,52,63,61,73,62,71],[14,11,3,9,7,26,19,22,20,17,42,41,"FREE",38,34,60,48,54,53,55,74,64,72,61,62],[15,10,3,14,7,22,21,27,17,23,40,45,"FREE",42,41,52,54,48,50,51,62,71,68,65,64],[9,2,3,4,15,27,21,19,22,29,31,35,"FREE",39,42,55,46,58,50,53,67,62,65,68,61],[15,2,13,1,10,16,19,17,29,22,44,37,"FREE",43,42,53,52,54,48,56,62,72,63,70,75],[14,13,2,7,15,21,24,19,28,22,36,43,"FREE",33,45,59,55,50,52,60,64,73,67,63,72],[7,13,5,4,9,16,19,28,30,23,38,40,"FREE",45,34,47,60,52,49,59,70,63,62,75,64],[10,1,11,4,3,29,25,20,28,21,32,37,"FREE",44,33,57,50,59,60,53,68,69,63,71,64],[13,1,12,15,4,28,24,27,21,30,41,33,"FREE",45,42,57,54,49,50,47,68,62,69,75,73],[7,13,3,1,15,16,23,19,24,28,45,40,"FREE",34,33,49,50,46,54,59,66,73,74,62,61],[3,2,4,15,6,29,23,27,16,19,39,45,"FREE",38,35,56,57,58,51,49,67,66,62,69,72],[2,8,12,3,9,22,25,16,24,26,35,39,"FREE",32,36,60,53,56,55,58,66,71,68,74,65],[14,7,10,3,9,23,25,17,27,16,31,40,"FREE",35,43,50,47,60,56,52,70,63,62,72,75],[2,9,5,13,15,24,20,30,28,29,35,31,"FREE",40,36,47,54,55,50,56,62,64,72,71,66],[15,7,13,10,4,29,26,21,20,19,33,44,"FREE",39,37,57,58,56,54,46,67,65,70,71,75],[3,7,6,10,15,24,18,30,21,29,38,39,"FREE",45,41,51,48,56,55,57,73,65,69,75,63],[3,10,9,14,12,26,19,16,24,20,44,41,"FREE",40,32,48,57,46,54,56,72,74,61,73,68],[2,8,12,10,1,30,26,19,20,28,41,32,"FREE",36,35,55,59,49,48,52,66,64,68,72,73],[3,8,7,12,15,17,26,22,16,18,32,39,"FREE",43,38,57,51,52,58,47,70,72,64,73,62],[2,5,15,8,9,21,20,17,24,26,43,34,"FREE",35,39,56,46,59,58,54,67,68,64,69,74],[11,13,3,9,12,20,22,27,21,19,38,44,"FREE",31,33,52,60,46,59,56,68,61,65,70,64],[4,13,8,9,10,18,29,25,23,27,35,45,"FREE",40,42,48,51,57,53,58,63,75,66,70,68],[4,7,14,5,9,21,16,28,30,20,32,38,"FREE",40,36,59,60,53,51,50,70,72,68,74,64],[10,14,6,7,9,25,21,20,27,23,39,34,"FREE",37,41,55,54,51,48,59,66,61,68,65,71],[1,8,12,13,2,25,18,24,21,28,43,36,"FREE",34,40,51,47,59,57,55,71,65,61,69,70],[11,2,6,14,7,17,24,16,29,22,42,32,"FREE",37,36,48,55,47,60,53,63,67,72,73,68],[1,13,5,11,7,19,24,25,21,16,39,38,"FREE",42,36,47,59,51,54,52,75,66,72,69,65],[15,1,3,12,8,25,23,30,18,28,41,40,"FREE",34,33,51,49,53,47,52,62,68,73,61,70],[9,3,8,6,7,17,30,25,28,23,33,45,"FREE",40,34,47,60,49,46,54,72,67,63,69,73],[10,13,7,3,2,17,29,26,25,18,34,37,"FREE",42,44,47,46,54,56,51,61,73,67,70,66],[8,13,4,12,6,20,24,28,30,27,32,44,"FREE",40,41,57,51,53,59,55,69,68,61,75,72],[12,10,4,3,15,17,30,24,16,29,44,43,"FREE",37,31,51,56,60,52,55,69,63,67,71,70],[14,3,9,7,15,16,23,18,27,30,44,33,"FREE",45,39,57,47,55,52,46,68,74,61,69,66],[14,5,12,7,1,19,16,29,26,30,44,39,"FREE",37,36,55,56,57,52,46,62,67,64,61,66],[2,10,7,15,3,19,29,20,30,23,34,31,"FREE",39,38,55,46,51,49,52,70,61,66,67,63],[9,8,15,10,11,19,30,18,23,29,31,44,"FREE",36,39,52,46,56,54,50,66,73,64,75,62],[12,3,11,7,15,18,27,20,26,24,40,44,"FREE",37,39,46,50,59,60,47,72,74,69,75,70],[14,8,13,6,9,23,18,25,20,16,34,32,"FREE",33,41,49,58,56,50,51,62,64,65,75,72],[1,4,7,12,10,17,21,19,27,25,35,33,"FREE",43,39,48,51,50,49,56,72,61,69,73,66],[11,9,15,6,7,29,17,30,23,16,34,40,"FREE",45,44,53,50,49,46,51,71,62,74,67,68],[5,4,14,3,8,26,21,20,19,22,33,42,"FREE",40,44,57,53,58,60,50,75,72,67,73,71],[2,3,8,9,12,20,16,19,21,28,34,43,"FREE",36,41,52,55,49,57,50,69,74,63,65,66],[2,3,8,7,11,20,17,23,29,22,35,38,"FREE",40,32,51,47,50,58,56,70,63,69,71,72],[7,10,4,15,6,25,24,28,22,17,34,44,"FREE",35,38,53,56,46,59,55,63,70,74,64,68],[7,13,1,12,14,23,19,21,25,24,45,33,"FREE",44,43,51,55,50,52,59,71,67,65,68,75],[9,8,6,4,3,20,21,23,30,29,37,35,"FREE",42,34,52,46,51,49,57,61,74,64,63,65],[2,12,11,5,6,25,28,26,16,19,32,44,"FREE",42,45,48,50,59,55,57,66,68,69,74,65],[13,6,2,12,8,17,25,28,20,29,39,34,"FREE",45,37,48,54,49,57,60,62,70,75,71,67],[12,8,11,7,2,26,17,19,18,28,39,31,"FREE",35,34,47,46,58,60,57,64,75,67,63,62],[2,14,5,3,9,27,23,25,24,18,39,45,"FREE",33,36,51,57,54,49,55,67,73,75,68,72],[1,4,9,3,8,27,29,25,19,16,41,32,"FREE",44,45,51,52,53,60,49,72,62,73,70,75],[13,2,15,3,9,30,26,25,27,28,43,45,"FREE",34,39,54,46,51,57,58,75,65,67,63,72],[7,9,14,6,2,27,16,26,25,17,45,36,"FREE",34,41,60,53,55,47,51,63,69,70,75,67],[8,1,2,10,6,26,28,16,27,23,43,34,"FREE",35,33,47,51,58,52,46,73,64,69,74,75],[7,13,5,9,10,28,22,18,19,21,45,39,"FREE",32,43,58,54,60,50,59,71,68,67,73,75],[3,13,6,10,2,19,28,16,30,25,45,36,"FREE",42,34,50,54,55,59,47,69,65,73,67,68],[8,13,10,7,3,25,16,19,18,23,34,41,"FREE",44,33,56,51,58,49,52,70,72,64,73,65],[11,13,12,15,7,24,22,30,19,25,42,36,"FREE",33,37,55,57,60,58,53,61,68,65,70,62],[4,3,7,10,9,24,29,17,27,22,40,38,"FREE",34,44,47,49,59,48,53,74,72,64,61,70],[1,6,8,5,14,16,30,18,24,23,34,44,"FREE",31,33,54,57,58,55,50,73,74,67,62,66],[1,15,10,12,2,27,20,26,23,17,44,41,"FREE",37,32,49,59,52,58,47,61,72,73,62,65],[15,10,13,14,1,20,27,24,29,21,34,39,"FREE",40,31,59,57,56,54,58,71,74,70,67,65],[13,4,7,8,6,22,29,20,23,21,42,31,"FREE",41,34,47,48,49,57,55,66,75,67,63,74],[2,5,11,6,13,19,25,21,26,18,42,45,"FREE",44,40,47,56,58,48,49,62,71,61,73,72],[1,5,6,8,4,24,21,20,22,16,34,31,"FREE",40,44,47,48,52,51,60,68,66,69,62,61],[9,7,5,15,2,26,22,25,21,18,39,35,"FREE",31,32,53,51,55,60,46,61,73,70,69,66],[7,10,5,3,11,16,18,21,19,25,45,31,"FREE",44,38,48,49,52,57,60,73,67,64,66,68],[2,8,6,4,3,21,22,19,26,29,31,32,"FREE",36,44,55,47,51,59,50,73,75,62,70,71]
        ];

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        const miID = localStorage.getItem('bingo_uid') || Math.random().toString(36).substr(2,9);
        localStorage.setItem('bingo_uid', miID);
        
        let misCartonesPagados = [];
        let misSelecciones = []; 
        let precioPorTabla = 50; 

        // 1. GENERAR BOTONES INMEDIATAMENTE (Sin esperar a Firebase)
        const cont = document.getElementById('contenedor-botones');
        cont.innerHTML = ""; // Limpiar texto de carga
        
        for(let i=0; i<LISTA_CARTONES.length; i++){
            let b = document.createElement('button');
            b.id = `btn-${i}`;
            b.innerText = i+1;
            b.className = 'btn-carton'; // Clase base
            
            // Asignar el clic directamente
            b.onclick = function() { clickCarton(i); };
            
            cont.appendChild(b);
        }

        // --- L√ìGICA DE SELECCI√ìN MANUAL ---
        function clickCarton(id) {
            const btn = document.getElementById(`btn-${id}`);
            if(!btn) return;

            // Si est√° ocupado o en revisi√≥n, ignorar
            if(btn.classList.contains('ocupado')) return;

            // Si es m√≠o y ya est√° pagado, entrar al juego
            if(btn.classList.contains('mio')) {
                entrarModoJuego();
                return;
            }

            // L√≥gica de Selecci√≥n (Toggle)
            if(misSelecciones.includes(id)) {
                misSelecciones = misSelecciones.filter(x => x !== id);
                btn.classList.remove('seleccionada');
            } else {
                misSelecciones.push(id);
                btn.classList.add('seleccionada');
            }
            actualizarBarraPago();
        }

        function actualizarBarraPago() {
            const barra = document.getElementById('barra-pago');
            const txtCant = document.getElementById('resumen-cant');
            const txtTotal = document.getElementById('resumen-total');

            if(misSelecciones.length > 0) {
                barra.style.display = 'flex'; // Mostrar barra
                txtCant.innerText = `${misSelecciones.length} tablas`;
                txtTotal.innerText = `${(misSelecciones.length * precioPorTabla).toFixed(2)} Bs`;
            } else {
                barra.style.display = 'none'; // Ocultar barra
            }
        }

        function abrirModal() {
            if(misSelecciones.length === 0) return;
            document.getElementById('modal-cant').innerText = misSelecciones.length;
            document.getElementById('modal-total').innerText = (misSelecciones.length * precioPorTabla).toFixed(2);
            document.getElementById('modal-pago').style.display = 'flex';
        }

        window.enviarPago = function() {
            const nom = document.getElementById('inp-nombre').value;
            const tel = document.getElementById('inp-telf').value;
            const refNum = document.getElementById('inp-ref').value;

            if(!nom || !tel || !refNum) return alert("Por favor llena todos los datos.");

            misSelecciones.forEach(id => {
                db.ref(`bingo/estados/${id}`).set({
                    uid: miID, 
                    nombre: nom, 
                    telefono: tel, 
                    referencia: refNum, 
                    status: 'revision', 
                    carton_id: id
                });
            });

            misSelecciones = [];
            actualizarBarraPago();
            document.getElementById('modal-pago').style.display='none';
            alert("¬°Solicitud enviada! Tus tablas se pondr√°n amarillas.");
        }

        // --- ESCUCHAR ESTADOS DE FIREBASE ---
        db.ref('bingo/estados').on('value', (snap) => {
            const data = snap.val() || {};
            misCartonesPagados = [];

            for(let i=0; i<LISTA_CARTONES.length; i++){
                const info = data[i];
                const btn = document.getElementById(`btn-${i}`);
                if(!btn) continue;

                // Limpiar clases de estado (pero mantener seleccionada si aplica)
                const estaSeleccionada = btn.classList.contains('seleccionada');
                btn.className = 'btn-carton'; // Reset
                if(estaSeleccionada) btn.classList.add('seleccionada');

                if(!info){
                    // LIBRE
                    btn.classList.add('libre');
                    btn.innerText = i+1;
                } else {
                    // OCUPADO
                    if(info.uid === miID){
                        // M√çO
                        btn.classList.add('mio');
                        if(info.status === 'revision') {
                            btn.innerText = "‚è≥";
                            btn.style.animation = "none";
                            btn.style.backgroundColor = "#f1c40f";
                        } else {
                            btn.innerHTML = "‚ñ∂Ô∏è";
                            misCartonesPagados.push({ id: i, ...info });
                        }
                    } else {
                        // DE OTRO (OCUPADO)
                        if(info.status === 'pagado' || info.status === 'revision') {
                            btn.classList.add('ocupado');
                            btn.innerText = "üîí";
                            // Si estaba seleccionado por error, deseleccionar
                            if(misSelecciones.includes(i)) {
                                misSelecciones = misSelecciones.filter(x => x !== i);
                                actualizarBarraPago();
                            }
                        }
                    }
                }
            }

            const btnEntrar = document.getElementById('btn-entrar-juego');
            if(misCartonesPagados.length > 0) {
                btnEntrar.style.display = 'block';
                document.getElementById('count-mis-tablas').innerText = misCartonesPagados.length;
            } else {
                btnEntrar.style.display = 'none';
            }
        });

        // --- MODO JUEGO ---
        window.entrarModoJuego = function() {
            if(misCartonesPagados.length === 0) return;

            document.getElementById('pantalla-seleccion').style.display='none';
            document.getElementById('pantalla-juego').style.display='block';
            document.getElementById('barra-pago').style.display='none'; 
            
            if(document.body) document.body.style.backgroundImage = "url('fondo-juego.png')";

            const area = document.getElementById('area-cartones');
            area.innerHTML = "";

            misCartonesPagados.forEach(cartonInfo => {
                const i = cartonInfo.id;
                const datos = LISTA_CARTONES[i];
                const vidas = cartonInfo.vidas || 1;

                let tarjeta = document.createElement('div');
                tarjeta.className = 'tarjeta-carton';
                
                let htmlGrid = `<div class="grid-juego" id="grid-${i}">`;
                ['B','I','N','G','O'].forEach(l => { htmlGrid += `<div class="header">${l}</div>`; });

                for (let r = 0; r < 5; r++) {
                    const indices = [0 + r, 5 + r, 10 + r, 15 + r, 20 + r];
                    indices.forEach(idx => {
                        let n = datos[idx];
                        let texto = (n === "FREE") ? "‚òÖ" : n;
                        let idCelda = (n === "FREE") ? `free-${i}` : `num-${n}-${i}`;
                        let claseExtra = (n === "FREE") ? "marcada" : "";
                        htmlGrid += `<div class="celda ${claseExtra}" id="${idCelda}">${texto}</div>`;
                    });
                }
                htmlGrid += `</div>`;

                tarjeta.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px; color:#f1c40f; font-weight:bold;">
                        <span>TABLA #${i+1}</span>
                        <span class="badge-vidas">‚ù§Ô∏è ${vidas}</span>
                    </div>
                    ${htmlGrid}
                `;
                area.appendChild(tarjeta);
            });

            escucharBolas();
        };

        window.volverAlLobby = function() {
            document.getElementById('pantalla-juego').style.display='none';
            document.getElementById('pantalla-seleccion').style.display='block';
            if(misSelecciones.length > 0) document.getElementById('barra-pago').style.display='flex';
            if(document.body) document.body.style.backgroundImage = "url('fondo.jpg')";
        };

        function escucharBolas() {
            db.ref('bingo/historial').on('value', (snap) => {
                const bolas = snap.val();
                
                if(!bolas) {
                    document.querySelectorAll('.celda').forEach(c => {
                        if(!c.innerText.includes("‚òÖ")) c.classList.remove('marcada');
                    });
                    return;
                }

                Object.values(bolas).forEach(n => {
                    const celdas = document.querySelectorAll(`[id^='num-${n}-']`);
                    celdas.forEach(c => c.classList.add('marcada'));
                });
            });
            
            db.ref('bingo/ganador').on('value', (snap) => {
                const ganador = snap.val();
                if(ganador && ganador.uid === miID) {
                    document.getElementById('aviso-gane').style.display = 'block';
                    try { navigator.vibrate([500, 300, 500]); } catch(e){}
                } else {
                    document.getElementById('aviso-gane').style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>